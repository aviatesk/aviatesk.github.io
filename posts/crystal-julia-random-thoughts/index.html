<!DOCTYPE html> <html lang=en > <meta charset=UTF-8  /> <meta name=viewport  content="width=device-width, initial-scale=1" /> <title>Another IDE</title> <meta property="og:url" content="posts/crystal-julia-random-thoughts" /> <meta property="og:title" content="Another IDE" /> <meta property="og:image" content="assets/what_about_the_dead_fish.jpeg" /> <meta property="og:type" content=article  /> <meta property="og:description" content="Crystal and Juila, random thoughts for next generation of IDE" /> <meta property="og:published_time" content=2020-12-31  /> <meta name="twitter:card" content=summary  /> <meta name="twitter:site" content="@kdwkshh" /> <meta name="twitter:creator" content="@kdwkshh" /> <link rel=stylesheet  href="/libs/highlight/atom-one-light.min.css"> <link rel=icon  href="/assets/what_about_the_dead_fish.jpeg" /> <link rel=stylesheet  href="/css/aviatesk.css" /> <navigation-bar><div class=navigation-info  id=site-info ><a href="/">Shuhei Kadowaki's homepage</a></div></navigation-bar><navigation-bar class=navigation-sticky ><navigation-hover> <a class=navigation-info  id=page-info >$ Another IDE</a> </navigation-hover> <navigation-hover> <img src="/assets/terminal.svg" id=terminal-icon  /> <ul id=site-cd > <li><a style="text-decoration: none" href="/">cd ~</a> <li><a style="text-decoration: none" href="/posts">cd posts</a> <li><a style="text-decoration: none" href="https://github.com/aviatesk">cd <i class="fab fa-github"></i></a> <li><a style="text-decoration: none" href="https://twitter.com/kdwkshh">cd <i class="fab fa-twitter"></i></a> <li><a style="text-decoration: none" href="javascript:history.back()">cd ..</a> </ul> </navigation-hover> </navigation-bar> <div class=franklin-content ><div class=blog-info > <blogtitle> Another IDE <a type="application/rss+xml" href="https://aviatesk.github.io/feed.xml" style="float: right"> <i class="fas fa-rss"></i> </a> </blogtitle> <div class=published-date > 31 December 2020 </div> </div> <p>Today I gave the <a href="https://crystal-lang.org/">Crystal language</a> a try. I was interested in how we can obtain type safety from its Ruby-like, easy and concise syntax. As I wrote more code, I found Crystal coding is somewhat similar to my coding experience with the <a href="https://julialang.org/">Julia language</a>. Well, the reason is clear; there is inter-procedural type inference in both languages, and we don&#39;t need to spread useless type annotations in order to obtain type safety and/or runtime performance, which I believe is quite nice thing.</p> <div class=caption >this simple program can be statically compiled by crystal compiler</div> <pre><code class="cr hljs"><span class=hljs-comment ># we don&#x27;t need any annotations like `summer(a : Array(Int32 | Float64))`</span>
<span class=hljs-function ><span class=hljs-keyword >def</span> <span class=hljs-title >summer</span></span>(a)
  ret = <span class=hljs-number >0</span>
  a.each { |e| ret += e  }
  ret
<span class=hljs-keyword >end</span>

ia = [<span class=hljs-number >1</span>, <span class=hljs-number >2</span>, <span class=hljs-number >3</span>]
p summer(ia) <span class=hljs-comment ># =&gt; 6</span>

fa = [<span class=hljs-number >1.0</span>, <span class=hljs-number >2.0</span>, <span class=hljs-number >3.0</span>]
p summer(fa) <span class=hljs-comment ># =&gt; 6.0</span></code></pre> <p><a href="https://crystal-lang.org/2014/12/06/another-language.html">This blog post</a> by Ary Borenzweig, one of Crystal&#39;s core devs was about the challenge for such languages: incremental compilation.</p> <p>With the existence of inter-procedural type inference, it&#39;s hard to compile code method by method, and as a consequence, incremental compilation tends to be slow. It also means REPL might not be doable, because a method can&#39;t be compiled without its entry point &#40;i.e. actual arguments&#41;. Because of this reason, Crystal doesn&#39;t have REPL yet<sup id="fnref:1"><a href="#fndef:1" class=fnref >[1]</a></sup>.</p> <p>Julia, in turn, is dynamically compiled and its JIT compilation always happens just after the entry point is known, so we can have a REPL without the problem &#40;well, it&#39;s not just there is a REPL, but rather it&#39;s a quite nice REPL - I don&#39;t know any other REPL that is better than Julia&#39;s&#41;.</p> <p>What about incremental compilation ? I think, in Julia&#39;s context, <a href="https://julialang.org/blog/2020/08/invalidations/">code cache invalidation</a> can be seen as a sort of incremental compilation. The invalidation is triggered on a method refinement so smartly that it only invalidates as least compiled code cache as possible<sup id="fnref:4"><a href="#fndef:4" class=fnref >[2]</a></sup>, but I&#39;d say the problem surely exists &#40;a.k.a. <a href="https://discourse.julialang.org/t/roadmap-for-a-faster-time-to-first-plot/22956">&quot;time to first plot&quot;</a>&#41;. Julia community&#39;s recent approach for that problem is to try hard to improve the code quality so that we eliminate type-instabilities to make it robust against future invalidations, which would be positive also from performance perspective. <a href="https://github.com/timholy/SnoopCompile.jl">SnoopCompile.jl</a> is the primary tool for this, by helping us finding where type-instabilities and invalidations happen.</p> <p>Well, code cache invalidation is rather an essential feature in a dynamic environment like REPL. While statically-compiled languages in general offer fancy IDE environments powered by incremental compilation, but it seems that incremental compilation in a form of compiled code invalidation is not usually integrated with their REPL &#40;even if it exists&#41;. E.g. here are examples where Scala and Haskell REPL don&#39;t seem to update previously-compiled code, while Julia can handle it and works as we expect<sup id="fnref:2"><a href="#fndef:2" class=fnref >[3]</a></sup>.</p> <div class=caption >compiled code invalidations in REPL</div> <table><p> <tr><p> <th><p>Language</p> <th><p>REPL code</p> </p> <tr><p> <td><p>Scala</p> <td><pre><code class="plaintext hljs">❯ sbt consoleQuick
...
[info] welcome to sbt 1.4.4 (AdoptOpenJDK Java 1.8.0_252)
...
Welcome to Scala 2.12.12 (OpenJDK 64-Bit Server VM, Java 1.8.0_252).
...</code></pre> <pre><code class="scala hljs">scala&gt; <span class=hljs-function ><span class=hljs-keyword >def</span> <span class=hljs-title >inner</span></span>(a: <span class=hljs-type >Int</span>) = <span class=hljs-type >Math</span>.sin(a)
inner: (a: <span class=hljs-type >Int</span>)<span class=hljs-type >Double</span>

scala&gt; <span class=hljs-function ><span class=hljs-keyword >def</span> <span class=hljs-title >outer</span></span>(a: <span class=hljs-type >Int</span>) = a + inner(a)
outer: (a: <span class=hljs-type >Int</span>)<span class=hljs-type >Double</span>

scala&gt; outer(<span class=hljs-number >1</span>)
res0: <span class=hljs-type >Double</span> = <span class=hljs-number >1.8414709848078965</span>

scala&gt; <span class=hljs-function ><span class=hljs-keyword >def</span> <span class=hljs-title >inner</span></span>(a: <span class=hljs-type >Int</span>) = <span class=hljs-type >Math</span>.cos(a) <span class=hljs-comment >// update `inner`</span>
inner: (a: <span class=hljs-type >Int</span>)<span class=hljs-type >Double</span>

scala&gt; outer(<span class=hljs-number >1</span>) <span class=hljs-comment >// here we want `outer` to be updated too, but ...</span>
res1: <span class=hljs-type >Double</span> = <span class=hljs-number >1.8414709848078965</span></code></pre> <p></p> </p> <tr><p> <td><p>Haskell</p> <td><pre><code class="plaintext hljs">❯ stack ghci
...
GHCi, version 8.6.5: http://www.haskell.org/ghc/  :? for help
...</code></pre> <pre><code class="haskell hljs">λ&gt; inner = sin
λ&gt; outer a = a + inner a
λ&gt; outer <span class=hljs-number >1</span>
<span class=hljs-number >1.8414709848078965</span>
λ&gt; inner = cos <span class=hljs-comment >-- update `inner`</span>
λ&gt; outer <span class=hljs-number >1</span> <span class=hljs-comment >--  here we want `outer` to be updated too, but ...</span>
<span class=hljs-number >1.8414709848078965</span></code></pre> <p></p> </p> <tr><p> <td><p>Julia</p> <td><pre><code class="plaintext hljs">❯ julia
               _
   _       _ _(_)_     |  Documentation: https://docs.julialang.org
  (_)     | (_) (_)    |
   _ _   _| |_  __ _   |  Type &quot;?&quot; for help, &quot;]?&quot; for Pkg help.
  | | | | | | |/ _` |  |
  | | |_| | | | (_| |  |  Version 1.7.0-DEV.202 (2020-12-31)
 _/ |\__&#x27;_|_|_|\__&#x27;_|  |  Commit 1ad6aeddf5 (0 days old master)
|__/                   |</code></pre> <pre><code class="julia hljs">julia&gt; inner(a) = sin(a)
inner (generic <span class=hljs-keyword >function</span> with <span class=hljs-number >1</span> method)

julia&gt; outer(a) = a + inner(a)
outer (generic <span class=hljs-keyword >function</span> with <span class=hljs-number >1</span> method)

julia&gt; outer(<span class=hljs-number >1</span>)
<span class=hljs-number >1.8414709848078965</span>

julia&gt; inner(a) = cos(a) <span class=hljs-comment ># update `inner`</span>
inner (generic <span class=hljs-keyword >function</span> with <span class=hljs-number >1</span> method)

julia&gt; outer(<span class=hljs-number >1</span>) <span class=hljs-comment ># yay, this is what we want !</span>
<span class=hljs-number >1.5403023058681398</span></code></pre> <p></p> </p> </p> </table> <p>Conversely, we could say Julia&#39;s coding environments other than REPL still don&#39;t make good use of its internal incremental compilation system &#40;in my opinion, at least&#41;. My idea is that we can re-use it for IDE features with real-time feedbacks.</p> <p>Say if we want fancy IDE features like type-level error linting for a dynamic language, but also want to preserve its easy and simple coding experience at the same time. If we have such a tool, we can find an error point or performance pitfall before we actually run the code without scattering type annotations that are only necessary for type checking, like Crystal can ensure type safety of simply-written code at compile time.</p> <p>Such a tool needs some kind of inter-procedural program analysis, rather than the other existing, promised <a href="https://en.wikipedia.org/wiki/Gradual_typing">gradual typing</a> approach<sup id="fnref:3"><a href="#fndef:3" class=fnref >[4]</a></sup>. But as I said above, it will suffer from real-time analysis speed; we will need analysis caching and its incremental invalidation in order to keep the analysis fast enough for real-time feedbacks in IDEs. Fortunately, Julia already has good implementations of type inference and its invalidation system that are originally necessary for the performance and dynamic coding. We can make good use of it to build a next generation of IDE.</p> <p>The idea outlined above is exactly what I&#39;m trying to realize with <a href="https://github.com/aviatesk/JET.jl">JET.jl</a>. I hope I could advance it to a stage where we can use it within VSCode in the next few months.</p> <hr /> <p><table class=fndef  id="fndef:1"> <tr> <td class=fndef-backref ><a href="#fnref:1">[1]</a> <td class=fndef-content ><a href="https://github.com/crystal-lang/crystal/issues/681">https://github.com/crystal-lang/crystal/issues/681</a> </table> <table class=fndef  id="fndef:4"> <tr> <td class=fndef-backref ><a href="#fnref:4">[2]</a> <td class=fndef-content >Technically, compiled code cache invalidation is done by tracking &quot;backeges&quot; of compiled method instance during JIT compilation. This <a href="https://julialang.org/blog/2020/08/invalidations/">blog post</a> may help you understand how code cache invalidation happens in action. </table> <table class=fndef  id="fndef:2"> <tr> <td class=fndef-backref ><a href="#fnref:2">[3]</a> <td class=fndef-content >I&#39;m not sure even if this problem is recognized by developers/users of those languages. Or the priority of REPL is not so high for them ? </table> <table class=fndef  id="fndef:3"> <tr> <td class=fndef-backref ><a href="#fnref:3">[4]</a> <td class=fndef-content >I think the gradual typing approach would be ineffective especially for Julia, because type annotations are about how a generic function dispatches to its method and so are closely related to how it <em>runs</em> rather than just helping a developer understand code. </table> </p> <div class=page-foot > <div class=copyright > &copy; Shuhei Kadowaki. Last modified: 2022-07-24. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> <script src="/libs/collapsible.js"></script> <script src="/libs/lodash.js"></script> <script src="/libs/onscroll.js"></script> <script> document.ontouchstart = () => {} </script>